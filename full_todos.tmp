# Full TODOs + Release Plan (WEB + Android)

This file is a release-oriented checklist derived from `plans/`:
- `plans/base plan.lua`
- `plans/screen list.lua`
- `plans/design plan.lua`

Current state (as of 2026-02-07):
- WEB: public pages + Request a Quote (Simple/Advanced) + portal login + Leads list/detail + assign PM + convert to project.
- API: auth (login/register/me) + quote-requests create/list/get (minimal).
- Android: Compose scaffold only (no real API integration yet).
- DB: MySQL (XAMPP) default; minimal schema exists (`mysql.sql` + migrations).

Rule for this workspace:
- Every change must be logged in `changelogs.lua`.

## Release Scope Proposal (v0.1 "Operational MVP")

WEB (Office-first):
- Public website + lead intake (Simple/Advanced quote request)
- Portal: Leads -> Projects (minimal) + Messages (per lead/project) + basic Files (download) + Timesheets (read)
- Admin: user management (basic) + audit log viewer (basic)

Android (Field-first):
- Login
- Today: Start/Stop time + quick capture entry points
- Projects: list + details (read-only first)
- Capture: photo/file upload with offline queue
- Messages: threads + send
- Profile: account + sign out

## TODO List (WEB)

- [x] Portal navigation per `plans/screen list.lua` (Dashboard, Leads, Projects, Messages, Timesheets, Admin)
- [ ] Projects module (minimum):
- [x] Project list (`/app/projects`) with filters (status, assigned PM)
- [x] Project detail (`/app/projects/:id`) Overview tab (status, address, client, team)
- [x] Convert lead -> project should redirect to created project detail (and link in lead view)
- [ ] Messages module (WEB):
- [x] Thread model: one thread per lead + one per project (auto-create if missing)
- [x] Inbox view + thread view + compose
- [x] Mark read/unread (optional MVP)
- [ ] Files/Uploads (WEB):
- [x] Secure download route (stream file via PHP) with ACL checks (owner + role)
- [x] Client visibility toggle for uploads (respects `client_visible`)
- [ ] Leads UX:
- [x] Add lead status transitions (quote_review, meeting_scheduled, etc. from plan)
- [x] Attachments table: show download links (after download route exists)
- [ ] Client portal (minimum):
- [x] Client can see own leads/projects and message thread
- [x] Basic approvals panel placeholder (quote/schedule/change) for future
- [ ] Admin basics:
- [x] Users list + create + set/reset password
- [x] Users: role changes + status toggle
- [x] Audit log viewer (basic list)
- [x] Audit log filters (entity/action)

## TODO List (API / Backend)

- [ ] Standardize API auth:
- [x] Bearer token only for mobile (`Authorization: Bearer ...`)
- [x] Token expiration + refresh strategy (or short-lived tokens + re-login for MVP)
- [x] Error format + request IDs for troubleshooting
- [ ] API endpoints needed for Android MVP:
- [x] GET `/api/projects` (assigned-to-me for employee/subcontractor)
- [x] GET `/api/projects/:id`
- [x] GET `/api/threads?scope=project|lead&scope_id=...`
- [x] GET `/api/threads/:id/messages` (pagination)
- [x] POST `/api/threads/:id/messages`
- [x] POST `/api/uploads` (multipart) or presign-like flow (phase 2)
- [x] POST `/api/timesheets/start`
- [x] POST `/api/timesheets/stop`
- [x] GET `/api/timesheets?from=...&to=...` (me)
- [x] Rate limiting per endpoint bucket (login, uploads, messages)
- [ ] Input validation hardening:
- [x] Central validator helpers (avoid copy/paste)
- [x] Consistent trimming, max lengths, allowed enum values
- [ ] File upload hardening:
- [x] Enforce safe storage paths + deny traversal
- [x] Enforce mime + size + count limits consistently (web + api)
- [x] Add server-side image re-encode (optional, but reduces risk)
- [x] Background jobs strategy for later (queue, email sending)

## TODO List (Database / Migrations)

- [ ] Expand roles and entity model (from `plans/base plan.lua`):
- [x] Users: add roles `employee`, `subcontractor`, `subcontractor_worker`
- [x] Subcontractors + subcontractor_workers tables
- [x] Project membership table (project_id <-> user_id + role_in_project)
- [x] Threads/Messages: add indexes (thread_id, created_at)
- [ ] Threads/Messages: unread tracking (phase 2)
- [x] Timesheets: add indexes (user_id, started_at)
- [ ] Timesheets: status (running/stopped) (phase 2)
- [x] Add `projects.status` enum consistency with plan (materials_planning, in_progress, completed, closed, etc.)
- [x] Keep MySQL and SQLite migrations in sync (or officially drop SQLite to reduce surface area)
- [x] Update `mysql.sql` after each migration set (release artifact)

## TODO List (Android App)

- [ ] Networking:
- [x] Retrofit/OkHttp client + JSON models
- [x] Auth flow: login + token storage via Jetpack Security (EncryptedSharedPreferences)
- [x] Global error handling (401 re-auth, offline mode)
- [ ] Offline storage:
- [ ] Room DB for cached projects and messages (phase 2)
- [x] Room DB for upload queue
- [ ] Sync engine:
- [x] WorkManager for background uploads + retries + constraints (WiFi optional)
- [ ] Conflict strategy (server-wins for MVP)
- [ ] Screens:
- [x] Today: start/stop timesheet
- [x] Today: current running timer UI (elapsed)
- [x] Projects: list read-only
- [x] Projects: detail read-only
- [x] Capture: camera intent / in-app camera, attach to project, stage (before/during/after), notes
- [x] Messages: threads list + thread view + send text
- [x] Messages: attach photo/file
- [x] Profile: me + sign out
- [ ] Permissions + privacy:
- [x] Runtime permissions (camera) + file picker (no storage permission)
- [x] Strip EXIF GPS by default (or make it opt-in)
- [ ] Release build:
- [x] Versioning (versionCode/versionName)
- [x] Signing configs + Proguard/R8
- [ ] Crash reporting (Sentry or similar) + basic analytics (optional)

## Security / Compliance (Release Gate)

- [ ] Production config rules:
- [ ] Require non-default `APP_KEY` in prod
- [ ] `APP_DEBUG=0`, `APP_ENV=prod`
- [ ] Secure cookies when HTTPS (Secure + SameSite)
- [ ] CSRF coverage review (all state-changing web routes)
- [ ] RBAC + per-project ACL enforcement (no data leakage)
- [ ] Brute force protections:
- [ ] Login lockout or increasing backoff
- [ ] Password reset token rotation + single-use enforcement (already partially present)
- [ ] Content Security Policy:
- [ ] Remove inline styles in views or introduce CSP nonces
- [ ] Privacy policy + terms text (even MVP)
- [ ] Backups:
- [ ] Document DB backup/restore for MySQL (mysqldump)
- [ ] Document uploads backup (storage/uploads)

## Performance / Reliability (Release Gate)

- [x] Pagination everywhere (Leads, Projects, Messages)
- [x] DB indexes on all filtering/sorting columns used in list screens
- [x] File streaming download (no full read into memory)
- [x] Static asset caching headers (Apache) + compression
- [x] Log rotation for `storage/logs/`
- [ ] Health checks / smoke tests:
- [x] DB connection test
- [x] Migrations status

## QA (Release Gate)

- [ ] Manual test checklist:
- [ ] Web: register/login/logout
- [ ] Web: quote request (simple + advanced) incl. invalid cases
- [ ] Web: lead list/detail, assign PM, convert to project
- [ ] Web: upload attachments + download with ACL
- [ ] Android: login, offline mode, capture -> queued -> uploaded, messages, timesheet start/stop
- [ ] Automated checks:
- [ ] PHP syntax lint (already available)
- [ ] Basic integration tests (HTTP happy paths) on staging

## Release Plan (Step By Step)

1. Freeze v0.1 scope and acceptance criteria (what MUST ship vs backlog).
2. DB design pass for missing MVP tables (project_members, subcontractors, etc.) and write migrations for MySQL (and SQLite only if still supported).
3. Implement backend API endpoints required by Android MVP (projects, threads/messages, uploads, timesheets).
4. Implement WEB portal modules needed for office usage:
5. Projects list/detail
6. Messages (lead/project)
7. Files download with ACL
8. Admin users + audit log viewer
9. Implement Android MVP end-to-end:
10. Auth + token storage
11. Offline queue + background sync
12. Projects + Capture + Messages + Timesheets screens wired to API
13. Security hardening sprint:
14. CSP plan (remove inline styles or add nonces)
15. Lockout/backoff + audit key actions
16. Review ACL rules and add missing checks
17. Performance pass:
18. Add indexes + pagination + cache headers
19. Large file upload/download testing
20. Release candidate (RC1) on staging:
21. Run migrations on staging DB + seed minimal admin
22. Run manual QA checklist + fix blockers
23. Release:
24. Tag version + export `mysql.sql` (final) + ship Android signed build (APK/AAB)
25. Post-release:
26. Monitor logs, handle hotfixes, create v0.1.1 plan

## Backlog After v0.1 (Phase 2 / v0.2+)

- [ ] Checklist / Scope builder + approvals (client)
- [ ] Schedule calendar + client schedule approval
- [ ] Inventory (materials/tools) + deliveries
- [ ] Reports (progress, issues, change requests)
- [ ] Notifications (email + push) + reminder automations
- [ ] Integrations (Drive/Dropbox, SMTP, backups)
